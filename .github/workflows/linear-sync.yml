name: Linear status sync (from branch)

permissions:
  contents: read
  pull-requests: write # needed to rename the PR

on:
  pull_request:
    types:
      [
        opened,
        reopened,
        synchronize,
        closed,
        ready_for_review,
        converted_to_draft,
      ]
  pull_request_review:
    types: [submitted]
  issues:
    types: [labeled]

jobs:
  sync-linear:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
      || (github.event_name == 'pull_request_review' && github.event.pull_request.head.repo.full_name == github.repository)
      || (github.event_name == 'issues' && github.event.issue.pull_request)

    steps:
      - name: Gather context
        id: ctx
        run: |
          echo "BRANCH=${GITHUB_HEAD_REF:-${{ github.event.pull_request.head.ref || '' }}}" >> $GITHUB_OUTPUT
          echo "MERGED=${{ github.event.pull_request.merged || false }}" >> $GITHUB_OUTPUT
          echo "ACTION=${{ github.event.action }}" >> $GITHUB_OUTPUT
          echo "IS_DRAFT=${{ github.event.pull_request.draft || false }}" >> $GITHUB_OUTPUT
          echo "REVIEW_STATE=${{ github.event.review.state || '' }}" >> $GITHUB_OUTPUT
          echo "LABEL_NAME=${{ github.event.label.name || '' }}" >> $GITHUB_OUTPUT
          echo "PR_NUMBER=${{ github.event.pull_request.number || '' }}" >> $GITHUB_OUTPUT
          echo "PR_TITLE=${{ github.event.pull_request.title || '' }}" >> $GITHUB_OUTPUT
          echo "CREATED_AT=${{ github.event.pull_request.created_at || github.event.issue.created_at || '' }}" >> $GITHUB_OUTPUT

      - name: Find Linear ticket from branch (tra-123)
        id: key
        run: |
          BRANCH="${{ steps.ctx.outputs.BRANCH }}"
          MATCH=$(echo "$BRANCH" | grep -oiE 'tra-[0-9]+' | head -n1 || true)
          if [ -z "$MATCH" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            TEAMKEY=$(echo "$MATCH" | sed -E 's/-[0-9]+$//' | tr '[:lower:]' '[:upper:]') # TRA
            NUM=$(echo "$MATCH" | grep -oE '[0-9]+')
            KEY="$TEAMKEY-$NUM"
            echo "team=$TEAMKEY" >> $GITHUB_OUTPUT
            echo "num=$NUM" >> $GITHUB_OUTPUT
            echo "key=$KEY" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Linear
        if: steps.key.outputs.skip != 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          TEAMKEY: ${{ steps.key.outputs.team }}
          NUM: ${{ steps.key.outputs.num }}
          ACTION: ${{ steps.ctx.outputs.ACTION }}
          MERGED: ${{ steps.ctx.outputs.MERGED }}
          IS_DRAFT: ${{ steps.ctx.outputs.IS_DRAFT }}
          REVIEW_STATE: ${{ steps.ctx.outputs.REVIEW_STATE }}
          LABEL_NAME: ${{ steps.ctx.outputs.LABEL_NAME }}
          PR_NUMBER: ${{ steps.ctx.outputs.PR_NUMBER }}
          PR_TITLE: ${{ steps.ctx.outputs.PR_TITLE }}
          CREATED_AT: ${{ steps.ctx.outputs.CREATED_AT }}
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          graph() {
            curl -sS -H "Content-Type: application/json" \
                 -H "Authorization: $LINEAR_API_KEY" \
                 -X POST https://api.linear.app/graphql \
                 -d "$1"
          }

          QUERY_PAYLOAD=$(jq -nc --arg teamKey "$TEAMKEY" --argjson num "$(jq -n --arg n "$NUM" '$n|tonumber')" \
          '{query: "query($teamKey:String!,$num:Float!){ issues(filter:{ number:{eq:$num}, team:{ key:{eq:$teamKey}}}){ nodes{ id number title state{ name } team{ key states{ nodes{ id name } } } } } }",
            variables:{ teamKey:$teamKey, num:$num }}')

          RES="$(graph "$QUERY_PAYLOAD")"

          ISSUE_ID=$(echo "$RES" | jq -r '.data.issues.nodes[0].id // empty')


          if [ -z "$ISSUE_ID" ]; then
            echo "Linear issue not found for $TEAMKEY-$NUM. Exiting."
            exit 0
          fi

          LINEAR_TITLE=$(echo "$RES"   | jq -r '.data.issues.nodes[0].title')
          CURRENT_STATE=$(echo "$RES"  | jq -r '.data.issues.nodes[0].state.name // ""')
          STATES_JSON=$(echo "$RES"    | jq    '.data.issues.nodes[0].team.states.nodes')


          TARGET=""
          case "$ACTION" in
            opened|reopened|synchronize)
              if [ "$IS_DRAFT" = "true" ]; then TARGET="In Progress"; else TARGET="In Review"; fi
              ;;
            ready_for_review)       TARGET="In Review" ;;
            converted_to_draft)     TARGET="In Progress" ;;
            submitted)
              case "$REVIEW_STATE" in
                CHANGES_REQUESTED|changes_requested) TARGET="Changes requested" ;;
                APPROVED|approved)                   TARGET="In Review" ;;
                *) TARGET="" ;;
              esac
              ;;
            closed)
              if [ "$MERGED" = "true" ]; then TARGET="Done"; else TARGET="Canceled"; fi
              ;;
            labeled)
              if [ "${LABEL_NAME,,}" = "duplicate" ]; then TARGET="Duplicate"; fi
              ;;
          esac

          if [ -z "$TARGET" ]; then
            echo "No target state for action '$ACTION'."
            exit 0
          fi
          if [ "$TARGET" = "$CURRENT_STATE" ]; then
            exit 0
          fi


          STATE_ID=$(echo "$STATES_JSON" | jq -r --arg name "$TARGET" '.[] | select(.name==$name) | .id' | head -n1)
          if [ -z "$STATE_ID" ]; then
            echo "State '$TARGET' not found. Available:"
            echo "$STATES_JSON" | jq -r '.[].name'
            exit 1
          fi

          UPDATE=$(jq -nc --arg issueId "$ISSUE_ID" --arg stateId "$STATE_ID" \
            '{query:"mutation($issueId:String!,$stateId:String!){ issueUpdate(id:$issueId, input:{ stateId:$stateId }){ success } }",
              variables:{ issueId:$issueId, stateId:$stateId }}')

          RES_UPD="$(graph "$UPDATE")"
          if [ "$(echo "$RES_UPD" | jq -r '.data.issueUpdate.success')" != "true" ]; then
            echo "Failed to update Linear issue state:"
            echo "$RES_UPD"
            exit 1
          fi


          
          # ---- Create or Update the Linear attachment (Links) ----
          
          PR_URL="https://github.com/$REPO/pull/$PR_NUMBER"
          PR_TITLE="[${TEAMKEY}-${NUM}]: ${LINEAR_TITLE}"
          
          CHECK_PAYLOAD=$(jq -nc --arg url "$PR_URL" \
            '{query:"query($url:String!){ attachmentsForURL(url:$url){ nodes{ id issue{ id } } } }",
              variables:{ url:$url }}')

          CHECK_RES="$(graph "$CHECK_PAYLOAD")"

          EXISTING_ID=$(echo "$CHECK_RES" | jq -r '.data.attachmentsForURL.nodes[0].id // empty')

          if [ -n "$EXISTING_ID" ]; then
            UPDATE_ATTACH=$(jq -nc \
              --arg id "$EXISTING_ID" \
              --arg title "$PR_TITLE" \
              '{query:"mutation($id:String!,$title:String!){ attachmentUpdate(id:$id, input:{ title:$title }){ success }}",
                variables:{ id:$id, title:$title }}')
            graph "$UPDATE_ATTACH" > /dev/null
          else
            CREATE_ATTACH=$(jq -nc \
              --arg issueId "$ISSUE_ID" \
              --arg url "$PR_URL" \
              --arg title "$PR_TITLE" \
              --arg icon "https://github.githubassets.com/favicons/favicon.png" \
              --argjson metadata "$(jq -n --arg repo "$REPO" --arg pr "$PR_NUMBER" --arg createdAt "${CREATED_AT:-}" '{repo:$repo, prNumber:$pr, createdAt:$createdAt}')" \
              '{query:"mutation($input: AttachmentCreateInput!){ attachmentCreate(input:$input){ success attachment{ id } } }",
                variables:{ input:{ issueId:$issueId, url:$url, title:$title, iconUrl:$icon, metadata:$metadata }}}')
            graph "$CREATE_ATTACH" > /dev/null
          fi
